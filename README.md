# chatuna
Final project repository in Freeuni/Android

WiFi direct ჩატის პროექტი შედგება რამდენიმე მნიშვნლოვანი ნაწილისაგან: UI, მონაცემების შენახვა, კავშირის დამყარება. გარდა ორი დევაისის დაკავშირებისა, პროექტის წერის ფარგლებში წამოიჭრა რამდენიმე მნიშვნელოვანი პრობლემა, ამიტომ მთლიანი სურათის აღსაქმელად დოკუმენტში განვიხილავთ მათაც და წარმოვადგენთ მათი გადაჭრის გზებსაც. 

დევაისის ამოცნობა:
იმისათვის, რომ თითოეულ ჯერზე ვიცოდეთ ვინ არის ჰოსტ დევაისი და ვინ არის მისი peer, უნდა გვქონდეს რაიმე მაიდენტიფიცირებელი ნიშანი. აღნიშნული ინფორმაციის მიიღების გზას წარმოადგენს WIFI_P2P_THIS_DEVICE_CHANGED_ACTION ბროადკასტის მიღების შემდგომ, WifiP2pDevice ობიექტის ამოღება და მისი სახელის გაგება. 
მთავარ პრობლემას წარმოადგენს ის, რომ სახელის ცოდნა საჭიროა ისტორიის აქტივიტიში, რათა სწორად მოხდეს ისტორიის წამოღება. ბროდკასტ რესივერის დარეგისტრირება კი ჩატის აქტივიტიში ხდება, ამრიგად, საჭირო ბროდკასტისთვის მოსმენა და დაკვირკვება შეუძლებელი ხდება. ამ პრობლემის გადაჭრა მოხდა შემდეგნაირად: 1. თუ მომხმარებელი ბაზაში არ გვყავს, ისტორიაც არ ექნება. 2. თუ მომხმარებელი ბაზაში დამატებულია, იუსერების ცხრილს გაუჩნდა ველი is_me, რითაც მარტივად მოვახერხებთ დევაისის ამოცნობას. 

ამოსაცნობი ობიექტებიდან სწორთან დაკავშირება: 
ისეთ გარემოში ყოფნისას, სადაც wifi-direct ის feature-ის მქონე ბევრი დევაისია, საკმაოდ რთულია როგორც თავად აპლიკაციის მომხმარებლის ჭრილში გამოყენება, ისე ტესტირება. ამიტომ, გადავწყვიტეთ თავდაპირველად მოცემული პირობიდან მცირედით გადაგვეხვია და უფრო მოსახერხებელი გაგვეხადა აპლიკაციის მოხმარება - peer-თან კავშირის დამყარება ხდება არა ავტომატურად, არამედ ლისტში წარმოდგენილი იუზერებიდან ერთ-ერთის ამორჩევის საფუძველზე. 

ძირითადი ნაწილი - კავშირი და დატის გაცვლა: 
კავშირის დამყარების ასპექტი ორი მთავარი კომპონენტისგან შედებოდა: პირველ რიგში მნიშვნელოვანი იყო მომხარიყო ორი დევაისის ერთმანეთთან დაკავშირება. მას შემდეგ კი, რაც ისინი ერთმანეთს ამოიცნობდნენ მათ შორის უნდა გახსნილიყო სოკეტები, რისი საშუალებითაც მოახდენდენ მონაცემების გაცვლას. როგორც ზემოთ აღვნიშნეთ, კავშირის დამყარება ხდება ლისტიდან სასურველი დევაისის არჩევის საფუძველზე, კლიკის შემდეგ ხდება გაგზავნა რექვესთის და მეორე მხარეს დაექსეფთების შემთხვევა უკვე იხსნება სოკეტი ორ დევაისს შორის. ამ დროს ორი დევაისიდან ერთი არის სერვერი და ელოდება ქონექშენის რექვესთს, მეორე კი კლიენტია და აგზავნის ამ რექვესტს. ხდება მონაცემების 1024 ბაიტიან ჩანკებად წაკითხვა და საჭირო მონაცემების როგორც იუზერისთვის გამოტანა, ისე მონაცემთა ბაზაში შენახვა. თუ აპლიკაცია მიიღებს WIFI_P2P_CONNECTION_CHANGED_ACTION ბროდკასტს და მოხდება disconnect,  დაიხურება გახსნილი სოკეტები. 
